---
import '../styles/main.css'
import '../styles/index.css'
import Main from '../layouts/Main.astro'
import { SITE_NAME } from '../config.js'

const MAX_PLAYERS = 10
---

<Main title={SITE_NAME}>
    <div class="container">
        <h1><span class="flip">ü™ô</span> Penny Game</h1>
        <p class="subtitle">Simulation Lean - Mesure du Flow et du Lead Time</p>

        <div class="game-setup">
            <div class="setup-controls">
                <div class="player-selector">
                    <h3>üë• Nombre de Joueurs</h3>
                    <div class="player-buttons" id="playerButtons">
                        {
                            Array.from({ length: MAX_PLAYERS - 1 }, (_, i) => {
                                const count = i + 2
                                return (
                                    <button
                                        class={`player-count-btn${count === MAX_PLAYERS ? ' active' : ''}`}
                                        data-count={count}
                                    >
                                        {count} Joueurs
                                    </button>
                                )
                            })
                        }
                    </div>
                </div>

                <div class="round-selector-container">
                    <h3>üèÅ Choix de la Manche</h3>
                    <div class="round-selector" id="roundSelector">
                        {
                            [
                                {
                                    number: 'Manche 1',
                                    title: 'Batch de 20',
                                    description:
                                        "Passer TOUTES les 20 pi√®ces d'un coup",
                                },
                                {
                                    number: 'Manche 2',
                                    title: 'Batch de 1',
                                    description:
                                        'Passer les pi√®ces une par une',
                                },
                            ].map((opt, idx) => (
                                <div
                                    class={`round-option${idx === 0 ? ' active' : ''}`}
                                    data-round={idx + 1}
                                >
                                    <div class="round-number">{opt.number}</div>
                                    <div class="round-title">{opt.title}</div>
                                    <div class="round-description">
                                        {opt.description}
                                    </div>
                                </div>
                            ))
                        }
                    </div>
                </div>
            </div>

            <div class="batch-info" id="batchInfo">
                <h3>üéÆ Configuration Actuelle</h3>
                <p id="configInfo">
                    <span id="selected-players">{MAX_PLAYERS}</span>
                    Joueurs - Manche
                    <span id="selected-round">1</span>
                </p>
            </div>
        </div>

        <div class="game-controls">
            <button class="btn btn-primary" id="startBtn"
                >D√©marrer la Manche</button
            >
            <button class="btn btn-success" id="resetBtn">R√©initialiser</button>
        </div>

        <div class="game-board players-5" id="gameBoard">
            <!-- TODO: Dynamically generate the player zones -->
        </div>

        <div class="results" id="results" style="display: none;">
            <h2>üìä R√©sultats de la Simulation</h2>
            <div class="total-time" id="totalTime"></div>
            <div class="stats-grid" id="statsGrid"></div>
            <div class="insights">
                <h3>üí° Enseignements Lean</h3>
                <ul id="insightsList">
                    {
                        [
                            "Batch Size: Observer l'impact de la taille des lots sur le temps de cycle",
                            "Flow: Analyser les goulots d'√©tranglement et les temps d'attente",
                            'Lead Time: Comparer le temps individuel vs. temps total du processus',
                            'Am√©lioration Continue: Discuter des optimisations possibles',
                        ].map((insight) => (
                            <li>
                                <strong>{insight.split(':')[0]}:</strong>{' '}
                                {insight.split(':')[1]}
                            </li>
                        ))
                    }
                </ul>
            </div>
        </div>
    </div>
</Main>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const playerButtons = document.getElementById('playerButtons')
        const roundSelector = document.getElementById('roundSelector')
        const gameBoard = document.getElementById('gameBoard')
        const playersSpan = document.getElementById('selected-players')
        const roundSpan = document.getElementById('selected-round')

        // Get initial selected player count from active button
        let selectedPlayers = 2 // fallback
        if (playerButtons) {
            const activeBtn = playerButtons.querySelector('button.active')
            if (activeBtn && activeBtn.dataset.count) {
                selectedPlayers = parseInt(activeBtn.dataset.count, 10)
            }
        }

        // Get initial selected round from active option
        let selectedRound = 1 // fallback
        if (roundSelector) {
            const activeRound = roundSelector.querySelector(
                '.round-option.active'
            )
            if (activeRound && activeRound.dataset.round) {
                selectedRound = parseInt(activeRound.dataset.round, 10)
            }
        }

        // Player count selection
        if (playerButtons) {
            playerButtons.querySelectorAll('button').forEach((btn) => {
                btn.addEventListener('click', () => {
                    playerButtons
                        .querySelectorAll('button')
                        .forEach((b) => b.classList.remove('active'))
                    btn.classList.add('active')
                    if (btn.dataset.count) {
                        selectedPlayers = parseInt(btn.dataset.count, 10)
                        updateConfig()
                        updateBoard()
                    }
                })
            })
        }

        // Round selection
        if (roundSelector) {
            roundSelector.querySelectorAll('.round-option').forEach((opt) => {
                opt.addEventListener('click', () => {
                    roundSelector
                        .querySelectorAll('.round-option')
                        .forEach((o) => o.classList.remove('active'))
                    opt.classList.add('active')
                    if (opt.dataset.round) {
                        selectedRound = parseInt(opt.dataset.round, 10)
                        updateConfig()
                    }
                })
            })
        }

        function updateConfig() {
            if (playersSpan)
                playersSpan.textContent = selectedPlayers.toString()
            if (roundSpan) roundSpan.textContent = selectedRound.toString()
        }

        function updateBoard() {
            if (!gameBoard) return
            gameBoard.className = `game-board players-${selectedPlayers}`
        }

        // Initial config
        updateConfig()
        updateBoard()
    })
</script>
